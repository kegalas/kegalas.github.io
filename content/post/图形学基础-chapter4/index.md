---
title: "图形学基础 Chapter4"
date: 2022-07-28T17:36:32+08:00
draft: false
tags: [图形学]
categories: 图形学
mathjax: true
markup: pandoc
---

## 为什么需要光线追踪

光栅化不能很好地处理全局效果。例如软阴影，以及光照的多次反射。

虽然光栅化很快，但是质量不非常好、不真实。

相比之下光线追踪效果会好很多，但是也非常慢。在过去算力不发达的时候，光栅化是一个实时的算法，而光线追踪是一个离线的算法。

## 基础的光线追踪算法

### 光线投射

1. 对每一个像素投射一条光线来生成一张图
2. 对光源发射一条光线来检查阴影

**Pinhole Camera Model**

首先从眼睛，或者说相机发出一条光线，穿过图像平面上的一个像素。然后和空间中的一个物体边缘相交。当然可以和一个物体多次、或者和多个物体相交，我们需要的是最近的。

然后对最近的这个交点进行着色计算。例如使用Blinn-Phong模型。

**Recursive(Whitted-Style) Ray Tracing**

仍然从相机发出一条光线，穿过图像平面上的一个像素。然后和空间中的一个物体边缘相交。当然，如果是较为镜面的物体，会继续反射光线的路径和下一个物体边缘相交。直到不出现镜面反射。如果是玻璃等透射物质，则要沿着折射光线继续，直到不透明物体。

### 光线的数学表示

光线由光源点和方向向量表示。

$$
\bm r(t) = \bm o+t\bm d\quad 0\leq t<\infty
$$

其中$t$是时间，$\bm o$是光源向量，$\bm d$是方向向量。

### 光线相交

**对于隐式表示的物体**

判断是否相交，例如一个球面：

$$
(\bm{p}-\bm{c})^2-R^2=0
$$

其中$\bm p$是球面上的点，$\bm c$是球心，和

$$
\bm r(t) = \bm o+t\bm d\quad 0\leq t<\infty
$$

相交，则要满足

$$
(\bm o+t\bm d-\bm c)^2-R^2=0
$$

只有$t$一个未知数，解即可。

其他的隐式表示的，或者说用代数形式表示的物体都可以这么判断相交。

**对于三角形网格**

首先，三角形一定能够确定一个平面。所以先判断光线和平面的相交，以及计算交点。再计算交点是否在三角形内。

一个平面可以表述为上面的一点和平面的法向量。

所有在平面上的点满足如下等式

$$
(\bm p-\bm p')\cdot \bm N = 0
$$

其中，$\bm p'$是平面上已知一点，$\bm N$是平面法向量。

判断光线和平面的交点：

和

$$
\bm r(t) = \bm o+t\bm d\quad 0\leq t<\infty
$$

联立，得

$$
(\bm o+t\bm d-\bm p')\cdot \bm N = 0
$$

解得

$$
t = \frac{(\bm p'-\bm o)\cdot \bm N}{\bm d\cdot\bm N}
$$

应确保$0\leq t<\infty$

*直接计算出交点重心坐标的方法*

Moller Trumbore Algorithm:

$$
\bm O+t\bm D = (1-b_1-b_2)\bm P_0+b_1\bm P_1+b_2\bm P_2
$$

$$
\begin{bmatrix}
t \\
b_1 \\
b_2
\end{bmatrix}=
\frac{1}{\bm S_1\cdot\bm E_1}
\begin{bmatrix}
\bm S_2\cdot\bm E_2 \\
\bm S_1\cdot\bm S \\
\bm S_2\cdot\bm D
\end{bmatrix}
$$

其中：

$$
\bm E_1=\bm P_1 - \bm P_0
$$

$$
\bm E_2=\bm P_2 - \bm P_0
$$

$$
\bm S=\bm O - \bm P_0
$$

$$
\bm S_1=\bm D \times \bm E
_2
$$

$$
\bm S_2=\bm S \times \bm E
_1
$$

## 光线追踪加速

### 包围盒

一个物体被完整地包含在一个长方体中，这个长方体称之为包围盒。有时有多个物体在内。

显然如果光线没有击中包围盒，光线也就不会击中物体。

由于长方体的六个面确定了六个平面，长方体又可以看作是三组平行平面的交叉。

我们通常会使用轴对齐的包围盒。即三组平面都平行于坐标面。

对每一组平面都求光线和其交点，都会求出一个近点和远点。将三组近点和远点比较，求出最远的近点和最近的远点，就是和包围盒的交点。当然同时注意$t\geq 0$

使用轴对齐的包围盒可以减少算法常数

例如对齐x轴时

$$
t = \frac{(\bm p'-\bm o)\cdot \bm N}{\bm d\cdot\bm N}=\frac{\bm p'_x-\bm o_x}{\bm d_x}
$$

### 空间均匀分割

找到一块区域，均匀地划分成正方形（三维情况为正方体）网格。在每个网格记录物体边缘的重叠情况。

对于光线穿过的每个网格中，枚举和网格有交集的所有物体，检测是否和光线相交。

网格划分太少，则很难于无划分区分开来。划分太多，则会有很多和网格的计算。

一个启发式的算法是，网格数等于C乘以物体数。在三维中C为27.

处理较好的情况是，有很多物体的情况。而处理不好的情况是，一个体育馆中心有一个茶壶等类似情况时。

### 不均匀的分割

见12章笔记KD-Tree。

下面讲解光线和KD-Tree中的小空间的相交处理。

首先从根节点开始。光线首先会和根节点表述的空间有两个交点。

然后判断和两个子节点是否有相交。如果没有则忽略。如果有，则持续往下分割。直到没有子节点，就判断小空间内的物体是否和光线相交。

### 层次包围盒(BVH)

见12章笔记。

## 辐射度量学

### 辐射能量

辐射能量是电磁辐射的能量。以焦耳（J）做单位，$Q$为符号。

### 辐射通量

辐射通量是每单位时间接收、发射、反射、传输的能量。

$$
\Phi\equiv\frac{dQ}{dt}
$$

单位是瓦特（W），或流明（lm）。

但流明和瓦特略有不同，流明作为光通量的单位，只考虑了可见光的通量，而瓦特作为辐射通量考虑了电磁波的全部通量。

### 辐射强度

辐射强度是每单位立体角所能从点光源接收到的辐射通量。

$$
I(\omega)\equiv\frac{d\Phi}{d\omega}
$$

对于可见光单位是坎德拉（cd），对于一般电磁波是$W/sr$。

### 立体角

圆的角：

$$
\theta = \frac{l}{r}
$$

其中$l$是弧长，以弧度制计算，总共有$2\pi$

对于球体的立体角

$$
\Omega = \frac{A}{r^2}
$$

其中$A$是球面上的面积，以弧度制计算，总共有$4\pi$

其微分如下

$$
dA=(rd\theta)(rsin\theta d\phi)=r^2sin\theta d\theta d\phi
$$

其中$\theta$是与$z$轴的夹角，$\theta$是与$x$轴的夹角。

$$
d\omega=\frac{dA}{r^2}=sin\theta d\theta d\phi
$$

所以有

$$
\Phi = \int_{S^2}Id\omega=4\pi I
$$

$$
I = \frac{\Phi}{4\pi}
$$


